header_selector: x-nylon-proxy

# plugins:
#   - name: go-users
#     type: ffi
#     file: ./examples/plugin_sdk.so
#     entry:
#       - sdk_handle_request
#     life_cycle:
#       setup: true
#       shutdown: true

services:
  - name: http-service
    service_type: http
    algorithm: round_robin # Options: round_robin, random, consistent, weighted
    endpoints:
      - ip: 127.0.0.1
        port: 3001
        # weight: 10 # Optional
      - ip: 127.0.0.1
        port: 3002
        # weight: 1 # Optional

  - name: http-service-2
    service_type: http
    algorithm: round_robin # Options: round_robin, random, consistent, weighted
    endpoints:
      - ip: 127.0.0.1
        port: 3001
      - ip: 127.0.0.1
        port: 3002
        weight: 3


middleware_groups:
  header-modifier:
    - plugin: RequestHeaderModifier
      payload:
        remove:
          - x-version
        set:
          - name: x-hb-conf
            value: "prefix->${env(HOMEBREW_PREFIX)}-${or(env(MY_APP_NAME), 'default')}"
          - name: x-request-id
            value: "${uuid(v7)}"
          - name: x-timestamp
            value: "${timestamp()}"
          - name: x-forwarded-for
            value: "${var(client_ip)}-${eq(var(client_ip), '127.0.0.1', 'local')}"
          - name: x-host
            value: "${header(host)}"
    - plugin: ResponseHeaderModifier
      payload:
        set:
          - name: x-request-id-false
            value: "${or(header(x-request-id-false), concat('foo', '-', uuid(v4)))}"
          - name: x-request-id
            value: "${header(x-request-id)}"
          - name: x-server
            value: ${or(env(SERVER_NAME), 'my-server')}